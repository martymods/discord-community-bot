<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Streetwalk Explorer — Discord</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1e0d3a, #05000f 55%, #02000a 100%);
        color: #f4edff;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        padding: 32px 18px;
      }

      .layout {
        width: 100%;
        max-width: 1400px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .intro {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .intro h1 {
        margin: 0;
        font-size: clamp(2rem, 3vw, 3rem);
        font-weight: 700;
      }

      .intro p {
        margin: 0 auto;
        max-width: 720px;
        line-height: 1.6;
        color: #d5c6ff;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }

      button {
        border: 0;
        border-radius: 999px;
        padding: 0.65rem 1.4rem;
        background: linear-gradient(135deg, #7e00ff, #b388ff);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        box-shadow: 0 12px 30px rgba(126, 0, 255, 0.35);
      }

      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      button:active {
        transform: translateY(1px);
      }

      .frame-wrapper {
        position: relative;
        flex: 1;
        min-height: min(78vh, 880px);
        border-radius: 24px;
        overflow: hidden;
        background: rgba(5, 0, 18, 0.85);
        box-shadow: 0 40px 110px rgba(0, 0, 0, 0.55);
      }

      iframe {
        width: 100%;
        height: 100%;
        border: 0;
        opacity: 0;
        transition: opacity 0.6s ease;
        background: #050013;
      }

      iframe.is-visible {
        opacity: 1;
      }

      iframe.is-hidden {
        opacity: 0;
      }

      .overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 14px;
        padding: 28px;
        text-align: center;
        background: rgba(3, 0, 12, 0.82);
      }

      .overlay[hidden] {
        display: none;
      }

      .spinner {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.18);
        border-top-color: #c59cff;
        animation: spin 1.1s linear infinite;
      }

      .overlay p {
        margin: 0;
        color: #e7ddff;
        line-height: 1.6;
      }

      .overlay p strong {
        color: #ffffff;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 900px) {
        body {
          padding: 24px 12px;
        }

        .frame-wrapper {
          min-height: 70vh;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="intro">
        <h1>Streetwalk — Discord</h1>
        <p>
          Explore the live Streetwalk map directly inside Discord. Use the embedded window below to
          navigate. If the site refuses to load inside Discord, you can open it in a new tab instead.
        </p>
        <div class="actions">
          <button id="open-external" type="button">Open Streetwalk in Browser</button>
        </div>
      </section>

      <section class="frame-wrapper">
        <iframe
          id="game-frame"
          title="Streetwalk game window"
          allow="fullscreen; geolocation"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
        ></iframe>

        <div id="loading-overlay" class="overlay">
          <div class="spinner" aria-hidden="true"></div>
          <p><strong>Loading Streetwalk…</strong><br />Hang tight while we pull the city online.</p>
        </div>

        <div id="fallback-overlay" class="overlay" hidden>
          <p>
            We couldn't embed Streetwalk automatically. Some browsers or permissions block external
            sites inside Discord.<br /><strong>Use the button above to open it in a new tab.</strong>
          </p>
        </div>
      </section>
    </main>

    <script type="module">
      const GAME_URL = '/activity/streetwalk/';
      const EXTERNAL_URL = 'https://streetwalk-web.onrender.com/';
      const frame = document.getElementById('game-frame');
      const openExternalButton = document.getElementById('open-external');
      const loadingOverlay = document.getElementById('loading-overlay');
      const fallbackOverlay = document.getElementById('fallback-overlay');

      frame.src = GAME_URL;

      openExternalButton?.addEventListener('click', () => {
        window.open(EXTERNAL_URL, '_blank', 'noopener');
      });

      let hasSettled = false;
      const settleState = (loaded) => {
        if (hasSettled) return;
        hasSettled = true;

        loadingOverlay?.setAttribute('hidden', '');

        if (loaded) {
          frame.classList.add('is-visible');
          fallbackOverlay?.setAttribute('hidden', '');
        } else {
          frame.classList.add('is-hidden');
          fallbackOverlay?.removeAttribute('hidden');
        }
      };

      const loadTimeout = setTimeout(() => settleState(false), 20000);

      frame?.addEventListener('load', () => {
        clearTimeout(loadTimeout);
        settleState(true);
      });

      frame?.addEventListener('error', () => {
        clearTimeout(loadTimeout);
        settleState(false);
      });

      window.addEventListener('message', (event) => {
        const payload = event?.data;
        if (!payload || typeof payload !== 'object') return;

        if (payload.type === 'streetwalk-proxy-ready') {
          clearTimeout(loadTimeout);
          settleState(true);
        } else if (payload.type === 'streetwalk-proxy-error') {
          clearTimeout(loadTimeout);
          settleState(false);
        }
      });
    </script>
  </body>
</html>
