<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Dreamworld Typing (Discord)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { overflow:auto; }
    .panel { background: rgba(0,0,0,.6); padding:12px; border-radius:12px; }
    .input { width:100%; font:inherit; padding:.6rem .8rem; border-radius:10px; border:1px solid #7e00ff33; background:#0b0013; color:#e0caff; outline:none }
    .btn { margin-top:.6rem; padding:.6rem .9rem; border-radius:10px; background:#7e00ff; color:white; border:0; cursor:pointer }
    .leaderboard-item { display:flex; gap:.5rem; align-items:center }
    .leaderboard-item img { width:24px; height:24px; border-radius:50% }
  </style>
</head>
<body>
  <h2>Dreamworld Typing ‚Äî Discord</h2>
  <div id="bg"></div>

  <div id="word-display-container">
    <div id="word-display">Loading‚Ä¶</div>
  </div>

  <div class="panel" style="max-width:520px; width:100%;">
    <div id="timer">‚è±Ô∏è 12</div>
    <form id="answer-form">
      <input id="answer" class="input" placeholder="Type the word and press Enter‚Ä¶" autocomplete="off" />
      <button class="btn" type="submit">Submit</button>
    </form>
  </div>

  <div id="leaderboard" class="panel" style="max-width:520px; width:100%;"></div>

  <script type="module">
    import DiscordSDK from "https://cdn.discordapp.com/embedded-apps/sdk/3.0.0/discord.js";

    const wordDisplay = document.getElementById('word-display');
    const leaderboardDiv = document.getElementById('leaderboard');
    const timerDisplay = document.getElementById('timer');
    const answerForm = document.getElementById('answer-form');
    const answerInput = document.getElementById('answer');

    const deathSounds = [
      "/sounds/PillDeathSound.mp3",
      "/sounds/PillDeathSound0.mp3",
      "/sounds/PillDeathSound1.mp3",
      "/sounds/PillDeathSound2.mp3",
      "/sounds/PillDeathSound3.mp3"
    ];

    const pillImage = document.createElement("img");
    pillImage.id = "pillImage";
    pillImage.src = "/photos/Character_Pill_1_AIM.gif";
    document.getElementById("word-display-container").appendChild(pillImage);

    const easyWords   = ['Glow','Club','Beat','Crowd','Neon','Vibe','Loop','Code','Tap','Ring'];
    const mediumWords = ['Voltage','Silencer','Daydream','Overclock','Spectrum','Phantom'];
    const hardWords   = ['Psychoacoustics','Anthropocene','Hyperconvergence','Transcendental'];

    const rewards = {
      easy:  { cash: 50,  xp: 5 },
      medium:{ cash: 120, xp: 15 },
      hard:  { cash: 300, xp: 40 }
    };

    let currentWord = '';
    let countdown = 12;
    let wordTimer;

    function pickRandomWord() {
      const r = Math.random();
      if (r < 0.6) return easyWords[Math.floor(Math.random()*easyWords.length)];
      if (r < 0.9) return mediumWords[Math.floor(Math.random()*mediumWords.length)];
      return hardWords[Math.floor(Math.random()*hardWords.length)];
    }

    function difficultyFor(word) {
      if (!word) return 'easy';
      if (word.length <= 5) return 'easy';
      if (word.length <= 8) return 'medium';
      return 'hard';
    }

    function startCountdown() {
      clearInterval(wordTimer);
      countdown = 12;
      timerDisplay.textContent = `‚è±Ô∏è ${countdown}`;
      wordTimer = setInterval(() => {
        countdown--;
        if (countdown >= 0) timerDisplay.textContent = `‚è±Ô∏è ${countdown}`;
        else clearInterval(wordTimer);
      }, 1000);
    }

    function scheduleNextWord() {
      setTimeout(displayWord, 12000);
    }

    function displayWord() {
      currentWord = pickRandomWord();
      wordDisplay.textContent = currentWord;
      wordDisplay.style.transition = 'none';
      pillImage.style.transition = 'none';
      wordDisplay.style.opacity = '0';
      pillImage.style.opacity = '0';
      wordDisplay.style.transform = 'scale(1)';
      pillImage.style.transform = 'translate(-50%, -50%) scale(1)';
      void wordDisplay.offsetWidth;
      wordDisplay.style.transition = 'transform 10s ease-in-out, opacity 1s ease-in';
      pillImage.style.transition = 'transform 10s ease-in-out, opacity 1s ease-in';
      wordDisplay.style.opacity = '1';
      pillImage.style.opacity = '1';
      wordDisplay.style.transform = 'scale(3)';
      pillImage.style.transform = 'translate(-50%, -50%) scale(3)';

      const difficulty = difficultyFor(currentWord);
      if (difficulty === 'easy') wordDisplay.style.color = 'limegreen';
      else if (difficulty === 'medium') wordDisplay.style.color = 'gold';
      else wordDisplay.style.color = 'red';

      startCountdown();
      scheduleNextWord();
      answerInput.value = '';
      answerInput.focus();
    }

    function renderEmptyLeaderboard(message) {
      leaderboardDiv.innerHTML = `<p style="margin:0;">${message}</p>`;
    }

    async function refreshLeaderboard(guildId) {
      if (!guildId) {
        renderEmptyLeaderboard('Join this activity from a Discord server to see the live leaderboard.');
        return;
      }
      try {
        const response = await fetch(`/api/game/leaderboard/${guildId}?limit=8`, { cache: 'no-store' });
        if (!response.ok) throw new Error('bad status');
        const payload = await response.json();
        const entries = payload?.leaderboard || [];
        if (!entries.length) {
          renderEmptyLeaderboard('Be the first to earn rewards and top the board.');
          return;
        }
        leaderboardDiv.innerHTML = entries.map((entry, index) => {
          const rank = index + 1;
          const pic = entry.avatar || '';
          const name = entry.username || `Player ${rank}`;
          const cash = entry.totalCashAwarded ?? 0;
          const xp = entry.totalXpAwarded ?? 0;
          return `
            <div class="leaderboard-item">
              ${pic ? `<img src="${pic}" alt="${name}" />` : '<span style="width:24px;height:24px;display:inline-block"></span>'}
              <strong>#${rank} ${name}</strong>
              <span style="margin-left:auto;">üí∞ ${cash.toLocaleString()} ‚Ä¢ ‚≠ê ${xp.toLocaleString()}</span>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Failed to load leaderboard', err);
        renderEmptyLeaderboard('Leaderboard temporarily unavailable.');
      }
    }

    async function bootstrapDiscord() {
      let clientId = '';
      try {
        const configRes = await fetch('/activity/config.json', { cache: 'no-store' });
        if (configRes.ok) {
          const cfg = await configRes.json();
          if (cfg?.clientId) clientId = cfg.clientId;
        }
      } catch (err) {
        console.warn('Failed to fetch activity config', err);
      }

      const discordSdk = new DiscordSDK(clientId || '0');
      try {
        await discordSdk.ready();
      } catch (err) {
        console.warn('Discord SDK failed to become ready', err);
      }

      let context = {};
      try {
        context = await discordSdk.commands.getContext();
      } catch (err) {
        console.warn('Unable to fetch Discord context', err);
      }

      let userInfo = context?.user || null;
      let accessToken = null;

      if (clientId) {
        try {
          const { code } = await discordSdk.commands.authorize({
            client_id: clientId,
            response_type: 'code',
            scope: ['identify']
          });
          const token = await discordSdk.commands.authenticate({ client_id: clientId, code });
          if (token?.user) userInfo = token.user;
          if (token?.access_token) accessToken = token.access_token;
        } catch (err) {
          console.warn('Discord auth failed; continuing as guest', err);
        }
      }

      const guildId = context?.guild?.id || null;
      const username = userInfo?.global_name || userInfo?.username || 'Guest';
      const avatar = userInfo?.avatar
        ? `https://cdn.discordapp.com/avatars/${userInfo.id}/${userInfo.avatar}.png`
        : '';

      window.__discord = {
        userId: userInfo?.id || null,
        guildId,
        accessToken,
        username,
        avatar
      };

      await refreshLeaderboard(guildId);
      return window.__discord;
    }

    function localCelebrate() {
      pillImage.src = "/photos/Character_Pill_1_DEATH.gif";
      new Audio(deathSounds[Math.floor(Math.random()*deathSounds.length)]).play();
      setTimeout(() => { pillImage.src = "/photos/Character_Pill_1_AIM.gif"; }, 800);
    }

    async function awardDiscordProgress(difficulty) {
      const identity = window.__discord || {};
      if (!identity.userId || !identity.guildId || !identity.accessToken) {
        return;
      }

      const reward = rewards[difficulty] || rewards.easy;
      try {
        await fetch('/api/game/award', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: identity.userId,
            guildId: identity.guildId,
            cash: reward.cash,
            xp: reward.xp,
            unlocks: difficulty === 'hard' ? ['legendary_typer'] : [],
            accessToken: identity.accessToken,
            username: identity.username,
            avatar: identity.avatar
          })
        });
        await refreshLeaderboard(identity.guildId);
      } catch (err) {
        console.error('Failed to sync award to Discord bot', err);
      }
    }

    answerForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const guess = answerInput.value.trim();
      if (!guess) return;
      if (guess.toLowerCase() === currentWord.toLowerCase()) {
        const diff = difficultyFor(currentWord);
        localCelebrate();
        await awardDiscordProgress(diff);
      }
      answerInput.value = '';
    });

    await bootstrapDiscord();
    displayWord();
    setInterval(() => {
      if (window.__discord?.guildId) refreshLeaderboard(window.__discord.guildId);
    }, 30000);
  </script>
</body>
</html>
